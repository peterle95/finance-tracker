import re, sys, io
from pathlib import Path
p = Path('finance-tracker.py')
text = p.read_text(encoding='utf-8')

changed = False

# 1) Rename Budget tab and add Settings tab
pattern_tab = r"self\.notebook\.add\(self\.budget_tab, text=\"Budget \& Settings\"\)"
if re.search(pattern_tab, text):
    text = re.sub(pattern_tab, "self.notebook.add(self.budget_tab, text=\"Budget\")", text)
    changed = True

insert_after = r"self\.create_budget_tab\(\)"
if re.search(insert_after, text):
    text = re.sub(insert_after, "self.create_budget_tab()\n\n        # Dedicated Settings tab\n        self.settings_tab = ttk.Frame(self.notebook)\n        self.notebook.add(self.settings_tab, text=\"Settings\")\n        self.create_settings_tab()", text, count=1)
    changed = True

# 2) Inject Auto Assign buttons after Remove Budget button
btn_line = r"ttk\.Button\(btn_frame, text=\"Remove Budget\", command=self\.remove_category_budget\)\.pack\(side='left', padx=5\)"
if re.search(btn_line, text):
    inject = "\n        ttk.Button(btn_frame, text=\"Auto Assign\", command=self.auto_assign_budgets).pack(side='left', padx=5)\n        ttk.Button(btn_frame, text=\"Assign Remaining\", command=self.assign_remaining_budget).pack(side='left', padx=5)"
    text = re.sub(btn_line, btn_line + inject, text)
    changed = True

# 3) Adjust save_category_budgets to avoid normalization and slider recreation
text = re.sub(r"\n\s*self\._normalize_sliders\(\)\n", "\n        # Do not normalize on save to preserve user-selected values.\n", text)
text = re.sub(r"\n\s*self\._create_budget_sliders\(\)\n", "\n        # Avoid recreating sliders on save; refresh views instead.\n        try:\n            self.refresh_category_budget_list()\n        except Exception:\n            pass\n        messagebox.showinfo(\"Success\", \"Budgets saved.\")\n", text)

# 4) Append new methods if not present
if 'def create_settings_tab(self):' not in text:
    text += "\n\n    def create_settings_tab(self):\n        main_frame = ttk.Frame(self.settings_tab, padding=\"10\")\n        main_frame.pack(fill='both', expand=True)\n        settings_frame = ttk.LabelFrame(main_frame, text=\"Monthly Settings & Balances\", padding=\"10\")\n        settings_frame.pack(fill='x', expand=False)\n        ttk.Label(settings_frame, text=\"Base Monthly Income:\").grid(row=0, column=0, sticky='w', pady=5)\n        self.income_entry = ttk.Entry(settings_frame, width=15)\n        self.income_entry.grid(row=0, column=1, pady=5)\n        ttk.Label(settings_frame, text=\"Bank Account Balance:\").grid(row=1, column=0, sticky='w', pady=5)\n        self.bank_account_entry = ttk.Entry(settings_frame, width=15)\n        self.bank_account_entry.grid(row=1, column=1, pady=5)\n        ttk.Label(settings_frame, text=\"Wallet Balance:\").grid(row=2, column=0, sticky='w', pady=5)\n        self.wallet_entry = ttk.Entry(settings_frame, width=15)\n        self.wallet_entry.grid(row=2, column=1, pady=5)\n        ttk.Label(settings_frame, text=\"Current Savings:\").grid(row=3, column=0, sticky='w', pady=5)\n        self.savings_entry = ttk.Entry(settings_frame, width=15)\n        self.savings_entry.grid(row=3, column=1, pady=5)\n        ttk.Label(settings_frame, text=\"Current Investments:\").grid(row=4, column=0, sticky='w', pady=5)\n        self.investment_entry = ttk.Entry(settings_frame, width=15)\n        self.investment_entry.grid(row=4, column=1, pady=5)\n        ttk.Label(settings_frame, text=\"Money Lent Balance:\").grid(row=5, column=0, sticky='w', pady=5)\n        self.money_lent_entry = ttk.Entry(settings_frame, width=15)\n        self.money_lent_entry.grid(row=5, column=1, pady=5)\n        ttk.Label(settings_frame, text=\"Daily Savings Goal:\").grid(row=6, column=0, sticky='w', pady=5)\n        self.daily_savings_entry = ttk.Entry(settings_frame, width=15)\n        self.daily_savings_entry.grid(row=6, column=1, pady=5)\n        ttk.Button(settings_frame, text=\"Save Settings\", command=self.save_settings).grid(row=7, column=1, pady=10, sticky='e')\n\n" 

if 'def auto_assign_budgets(self):' not in text:
    text += "\n    def auto_assign_budgets(self):\n        month_str = self.budget_month.get() if hasattr(self, 'budget_month') else datetime.now().strftime(\"%Y-%m\")\n        cat_type = self.budget_cat_type_var.get() if hasattr(self, 'budget_cat_type_var') else \"Expense\"\n        if cat_type != \"Expense\":\n            messagebox.showinfo(\"Info\", \"Auto-assign currently supports Expense budgets.\")\n            return\n        categories = self.categories.get(\"Expense\", [])\n        if not categories:\n            messagebox.showinfo(\"No Categories\", \"No expense categories available.\")\n            return\n        totals_by_cat = {cat: 0.0 for cat in categories}\n        for e in self.expenses:\n            try:\n                if e['date'].startswith(month_str) and e.get('category') in totals_by_cat:\n                    totals_by_cat[e['category']] += float(e.get('amount', 0) or 0)\n            except Exception:\n                continue\n        total_spent = sum(totals_by_cat.values())\n        net_available = self._compute_net_available_for_spending(month_str)\n        if total_spent <= 0:\n            messagebox.showinfo(\"No Data\", \"No expenses in the selected month to auto-assign from.\")\n            return\n        assigned_percent = {}\n        leftover_pct = 0.0\n        if net_available > 0 and total_spent <= net_available:\n            for cat in categories:\n                assigned_percent[cat] = (totals_by_cat[cat] / net_available) * 100.0\n            leftover_pct = max(0.0, 100.0 - sum(assigned_percent.values()))\n        else:\n            # Overspent or no budget; scale to 100% by share of spending\n            for cat in categories:\n                assigned_percent[cat] = (totals_by_cat[cat] / total_spent) * 100.0\n            leftover_pct = 0.0\n        for cat in assigned_percent:\n            assigned_percent[cat] = round(assigned_percent[cat], 2)\n        total_assigned = sum(assigned_percent.values())\n        if total_assigned > 100.0:\n            factor = 100.0 / total_assigned if total_assigned > 0 else 0.0\n            for cat in assigned_percent:\n                assigned_percent[cat] = round(assigned_percent[cat] * factor, 2)\n            leftover_pct = 0.0\n        if 'category_budgets' not in self.budget_settings:\n            self.budget_settings['category_budgets'] = {'Expense': {}, 'Income': {}}\n        for cat, pct in assigned_percent.items():\n            self.budget_settings['category_budgets']['Expense'][cat] = pct\n        self.save_data()\n        self.refresh_category_budget_list()\n        self._remaining_budget_percentage = round(leftover_pct, 2)\n        self._remaining_budget_amount = round((leftover_pct / 100.0) * net_available, 2)\n        if self._remaining_budget_percentage > 0:\n            messagebox.showinfo(\"Remaining Budget\", f\"Leftover: {self._remaining_budget_percentage:.2f}% ( €{self._remaining_budget_amount:.2f}). Select a category and click 'Assign Remaining' to allocate it.\")\n        else:\n            messagebox.showinfo(\"Auto Assign Complete\", \"Budgets assigned based on current expenses.\")\n\n"

if 'def assign_remaining_budget(self):' not in text:
    text += "\n    def assign_remaining_budget(self):\n        cat_type = self.budget_cat_type_var.get() if hasattr(self, 'budget_cat_type_var') else \"Expense\"\n        if cat_type != \"Expense\":\n            messagebox.showerror(\"Error\", \"Assign Remaining is only supported for Expense budgets.\")\n            return\n        leftover_pct = getattr(self, '_remaining_budget_percentage', 0.0) or 0.0\n        if leftover_pct <= 0.0:\n            messagebox.showinfo(\"No Remaining\", \"No remaining budget to assign.\")\n            return\n        category = self.budget_category_var.get() if hasattr(self, 'budget_category_var') else \"\"\n        if not category:\n            messagebox.showerror(\"Error\", \"Select a category to assign the remaining budget.\")\n            return\n        current_pct = self.budget_settings.get('category_budgets', {}).get('Expense', {}).get(category, 0.0)\n        new_pct = min(round(current_pct + leftover_pct, 2), 100.0)\n        self.budget_settings.setdefault('category_budgets', {}).setdefault('Expense', {})[category] = new_pct\n        self._remaining_budget_percentage = 0.0\n        self._remaining_budget_amount = 0.0\n        self.save_data()\n        self.refresh_category_budget_list()\n        messagebox.showinfo(\"Assigned\", f\"Assigned remaining to {category}. New limit: {new_pct:.2f}%.\")\n\n"

if changed:
    p.write_text(text, encoding='utf-8')
    print('Patched finance-tracker.py successfully.')
else:
    print('No changes applied; patterns not found or already modified.')
